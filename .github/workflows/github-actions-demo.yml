name: GitHub Actions Demo
on: [push, workflow_dispatch]
jobs:
  Explore-GitHub-Actions:
    runs-on: ubuntu-latest
    steps:
      # TESTINGS
      - run: echo "üéâ The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "üêß This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      - run: echo "üîé The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
      - name: Check out repository code
        uses: actions/checkout@v2
        with:
          submodules: recursive
      - run: echo "üí° The ${{ github.repository }} repository has been cloned to the runner."
      - run: echo "üñ•Ô∏è The workflow is now ready to test your code on the runner."
      - run: echo "üçè This job's status is ${{ job.status }}."

      # CHECK submodule and update
      - run: pwd
      - run: git status
      - run: git submodule update
      - name: List files in the repository (before)
        run: |
          ls -lha ~/ ${{ github.workspace }} ~/.opam ${{ github.workspace }}/text.sickhack.net || true

      # CACHE CONTROL
      - name: OPAM Cache
        uses: actions/cache@v2.1.6
        env:
          cache-name: cache-opam
        with:
          # A list of files, directories, and wildcard patterns to cache and restore
          path: ~/.opam
          # An explicit key for restoring and saving the cache
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('.cachemark', '**/Makefile') }}
      # SETUP
      - name: Set up OCaml
        # You may pin to the exact commit or the version.
        # uses: ocaml/setup-ocaml@6d924c1a7769aa5cdd74bdd901f6e24eb05024b1
        uses: ocaml/setup-ocaml@v1.1.11
        with:
          # Version of the OCaml compiler to initialise
          ocaml-version: 4.12.0
      - run: opam install --yes cohttp-lwt-unix cohttp-async lambdasoup ocamlfind yojson lwt_ssl
      - name: Setup Ruby, JRuby and TruffleRuby
        uses: ruby/setup-ruby@v1.81.0
        with:
          ruby-version: 2.7.4
          bundler-cache: true
      - run: gem install jekyll bundler

      # OPERATIONS
      - run: |
          ls -lha ${{ github.workspace }} ~/.opam ${{ github.workspace }}/text.sickhack.net 
      - run: |
          bundle
          bundle exec jekyll build
        working-directory: ${{ github.workspace }}/text.sickhack.net


      # CHECK 
      - name: List files in the repository (after)
        run: |
          ls -lha ~/ ${{ github.workspace }} ~/.opam ${{ github.workspace }}/text.sickhack.net
          
      # SSH testing
      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3
        with:
          limit-access-to-actor: true
